##### Swarm: 서비스 Task가 죽었을 때 자동 복구 방법 #####

> **참고:** 이 실습에서는 작업자 노드 IP로 `192.168.0.3`을 사용합니다. 실제 환경에 맞게 IP 주소를 변경하여 실행하세요.

**1) Manager Node: 복구 테스트용 서비스 생성**
자동 복구 기능을 테스트하기 위해 2개의 복제본을 가진 `nginx-recover` 서비스를 생성합니다.

```bash
docker service create --name nginx-recover --replicas 2 --publish published=8083,target=80 nginx
```

```tech
docker, swarm, nginx
```

```desc
#### 🚀 복구 테스트용 서비스 생성
Swarm의 자동 복구(Self-healing) 기능을 시험하기 위한 Nginx 서비스를 생성합니다.

- **`--replicas 2`**: 2개의 컨테이너를 실행하도록 설정
- **`--name nginx-recover`**: 서비스의 목적을 알기 쉽게 이름 지정

> 💡 일부러 컨테이너를 중지시켜서 Swarm이 약속된 상태(`replicas 2`)를 유지하기 위해 어떻게 반응하는지 관찰할 것입니다.
```

**2) Manager Node: Worker Node에서 실행 중인 Task 컨테이너 ID 확인**
`docker service ps`를 사용하여 작업자 노드(192.168.0.3)에서 실행 중인 `nginx-recover` 컨테이너의 ID를 확인합니다. (만약 Worker가 아닌 Manager에서 2개 모두 실행된다면, `docker service update --force nginx-recover`로 재배치)

```bash
docker service ps nginx-recover
```

```tech
docker, swarm
```

```desc
#### 🔍 중지시킬 컨테이너(Task) 확인
`docker service ps`를 사용하여 현재 실행 중인 작업(컨테이너)의 목록과 위치를 확인합니다.

- **`docker service ps nginx-recover`**: `nginx-recover` 서비스의 작업 목록을 표시
- **`NODE`** 컬럼: 작업이 실행 중인 노드를 확인

> 💡 어떤 노드의 컨테이너를 중지시킬지 미리 파악하는 단계입니다.
```

**3) Worker Node: 컨테이너 강제 종료**
작업자 노드(192.168.0.3)에 접속하여, 이전 단계에서 확인한 컨테이너 ID를 사용하여 `docker kill` 명령으로 컨테이너를 강제로 종료시킵니다.

```bash
docker kill $(docker ps --filter "name=nginx-recover" -q)
```

```tech
docker, swarm
```

```desc
#### 💥 컨테이너 강제 종료
`docker kill` 명령을 사용하여 테스트용 컨테이너 중 하나를 의도적으로 중지시킵니다.

- **`docker kill`**: 실행 중인 컨테이너에 종료 신호를 보내 강제로 중단
- **`$(...)`**: ��호 안의 명령 결과를 `docker kill`의 인자로 사용
- **`docker ps ... -q`**: 특정 이름의 컨테이너 ID만 출력

> 💡 이 명령은 작업자 노드에서 직접 실행하여, 해당 노드의 컨테이너를 중지시키는 상황을 시뮬레이션합니다.
```

**4) Manager Node: 서비스 상태 변화 및 자동 복구 모니터링**
관리자 노드에서 `watch`를 사용하여 `nginx-recover` 서비스의 상태를 실시간으로 확인합니다. 종료된 Task는 `Shutdown` 상태가 되고, Swarm 스케줄러가 즉시 새로운 Task를 생성하여 `Running` 상태로 만드는 것을 볼 수 있습니다.

```bash
timeout 10 watch docker service ps nginx-recover
```

```tech
docker, swarm
```

```desc
#### ⏱️ 자동 복구 과정 모니터링
`watch`를 사용하여 컨테이너가 중지된 후 Swarm이 어떻게 반응하는지 실시간으로 관찰합니다.

- **`watch docker service ps ...`**: 서비스의 작업 상태를 계속해서 확인
- **`Shutdown`**: 방금 `kill`한 컨테이너의 상태
- **`Preparing` -> `Running`**: Swarm이 대체할 새 컨테이너를 생성하고 실행하는 과정

> 💡 관리자가 직접 개입하지 않아도 Swarm이 스스로 문제를 감지하고 복구하는 것을 볼 수 있습니다.
```

**5) Manager Node: 최종 복��� 상태 확인**
잠시 후, `REPLICAS`가 다시 `2/2`로 복구되었는지 확인하여 Swarm의 자동 복구 기능이 정상적으로 동작했음을 증명합니다.

```bash
docker service ls
```

```tech
docker, swarm
```

```desc
#### ✅ 최종 복구 상태 확인
`docker service ls`를 통해 서비스의 복제본 수가 다시 `2/2`로 돌아왔는지 최종 확인합니다.

- **`REPLICAS`**: `2/2`는 서비스가 다시 정상 상태로 복구되었음을 의미

> 💡 이로써 Swarm은 클러스터의 상태를 선언된 대로(desired state) 유지하려는 특징이 있음을 알 수 있습니다.
```