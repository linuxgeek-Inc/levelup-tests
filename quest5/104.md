##### Swarm: 서비스 롤링 업데이트 #####

**참고:** 이 실습에서는 관리자 노드 IP로 `192.168.0.2`을 사용합니다. 실제 환경에 맞게 IP 주소를 변경하여 실행하세요.

**1) Manager Node: 이전 버전 Nginx 서비스 생성**
롤링 업데이트를 실습하기 위해, 먼저 특정 버전(1.21)의 Nginx로 `nginx-updater` 서비스를 생성합니다.

```bash
docker service create --name nginx-updater --replicas 2 --publish published=8082,target=80 nginx:1.21
```

```tech
docker, swarm, nginx
```

```desc
#### 🚀 이전 버전 서비스 생성
롤링 업데이트를 테스트하기 위해 특정 구버전(1.21)의 Nginx 서비스를 생성합니다.

- **`docker service create`**: 새로운 서비스를 생성
- **`nginx:1.21`**: Nginx 이미지의 특정 버전을 지정

> 💡 업데이트 전의 상태를 만들기 위해 의도적으로 이전 버전을 배포합니다.
```

**2) Manager Node: 배포된 Nginx 버전 확인**
서비스에 접속하여 현재 배포된 Nginx의 버전을 확인합니다. `Server` 헤더에서 `nginx/1.21.x`를 확인할 수 있습니다.

```bash
curl --head http://192.168.0.2:8082
```

```tech
docker, swarm, nginx
```

```desc
#### 🔍 현재 버전 확인
`curl --head`를 사용하여 서비스의 HTTP 응답 헤더를 확인하고, 현재 실행 중인 Nginx 버전을 파악합니다.

- **`curl --head`**: HTTP 본문 없이 헤더 정보만 가져옴
- **`Server: nginx/1.21.x`**: 응답 헤더에서 현재 버전을 확인할 수 있음

> 💡 업데이트가 제대로 되었는지 비교하기 위해 현재 상태를 기록하는 과정입니다.
```

**3) Manager Node: 서비스 롤링 업데이트 실행**
`docker service update` 명령어를 사용하여 `nginx-updater` 서비스의 이미지를 `latest` 버전으로 업데이트합니다. Swarm은 기존 컨테이너를 한 번에 하나씩 새로운 버전으로 교체합니다.

```bash
docker service update --image nginx:latest nginx-updater
```

```tech
docker, swarm, nginx
```

```desc
#### 🔄 서비스 롤링 업데이트 실행
`docker service update`를 사용하여 서비스 중단 없이 이미지를 새 버전으로 교체합니다.

- **`docker service update`**: 실행 중인 서비스의 설정을 변경
- **`--image nginx:latest`**: 서비스의 이미지를 `nginx:latest`로 변경
- **`nginx-updater`**: 업데이트할 서비스의 이름

> 💡 Swarm은 기본적으로 한 번에 하나씩 구버전 컨테이너를 내리고 새 버전 컨테이너를 올리는 '롤링 업데이트'를 수행하여 서비스 가용성을 유지합니다.
```

**4) Manager Node: 롤링 업데이트 과정 실시간 모니터링**
`watch`를 사용하여 서비스의 작업(Task) 상태를 실시간으로 관찰합니다. 이전 버전의 컨테이너가 `Shutdown`되고 새로운 버전의 컨테이너가 `Running` 상태가 되는 과정을 볼 수 있습니다.

```bash
timeout 10 watch docker service ps nginx-updater
```
```no-err-check
```
```tech
docker, swarm
```

```desc
#### ⏱️ 업데이트 과정 모니터링
`watch`와 `docker service ps`를 이용해 롤링 업데이트 과정을 실시간으로 지켜봅니다.

- **`watch docker service ps ...`**: 서비스의 작업 상태를 주기적으로 확인
- **`Shutdown`**: 구버전 컨테이너가 종료되는 상태
- **`Running`**: 새 버전 컨테이너가 실행되는 상태

> 💡 컨테이너들이 순차적으로 교체되는 모습을 통해 무중단 업데이트가 어떻게 이루어지는지 확인할 수 있습니다.
```

**5) Manager Node: 업데이트된 Nginx 버전 확인**
업데이트가 완료된 후, 다시 서비스에 접속하여 `Server` 헤더가 최신 버전으로 변경되었는지 확인합니다.

```bash
curl --head http://192.168.0.2:8082
```

```tech
docker, swarm, nginx
```

```desc
#### ✅ 최종 버전 확인
업데이트 완료 후, 다시 `curl --head`를 실행하여 Nginx 버전이 성공적으로 변경되었는지 최종 확인합니다.

- **`Server: nginx/1.2x.x`**: 응답 헤더의 버전이 이전과 다른 최신 버전으로 표시되어야 함

> 💡 이전 버전과 비교하여 서버 버전이 올라갔다면 롤링 업데이트가 성공적으로 완료된 것입니다.
```

**6) 실습 종료**

```bash
: quit
```

```tech
bash,rocky
```

```desc
#### 👋 실습 종료
실습을 종료를 의미하는 `quit` 명령어를 실행합니다.
현재 터미널 세션을 종료합니다.

> 💡 모든 실습을 마친 후 사용합니다.
```