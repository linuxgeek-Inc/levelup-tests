##### Swarm: 3개 복제본 Nginx 서비스 생성 방법 #####

> **참고:** 이 실습에서는 관리자 노드 IP로 `192.168.0.2`을 사용합니다. 실제 환경에 맞게 IP 주소를 변경하여 실행하세요.

**1) Manager Node: 3개 복제본을 가진 Nginx 서비스 생성**
관리자 노드에서 `replicas` 옵션을 `3`으로 설정하여, 3개의 컨테이너(작업)가 실행되는 `nginx-x3` 서비스를 생성합니다. 포트는 8081로 매핑합니다.

```bash
docker service create --name nginx-x3 --replicas 3 --publish published=8081,target=80 nginx:latest
```

```tech
docker, swarm, nginx
```

```desc
#### 🚀 3개 복제본을 가진 서비스 생성
Nginx 서비스를 생성하되, 3개의 동일한 컨테이너가 동시에 실행되도록 설정합니다.

- **`docker service create`**: 새로운 서비스를 생성
- **`--replicas 3`**: 서비스의 컨테이너(복제본) 수를 3개로 지정
- **`--publish ...`**: 호스트의 8081 포트를 컨테이너의 80 포트로 연결
- **`--name nginx-x3`**: 서비스 이름을 `nginx-x3`로 설정

> 💡 `--replicas` 옵션으로 서비스의 규모를 쉽게 확장(Scale out)할 수 있습니다.
```

**2) Manager Node: 서비스 복제본 상태 확인**
`docker service ls` 명령어로 `nginx-x3` 서비스의 `REPLICAS`가 `3/3`으로 표시되는지 확인합니다.

```bash
docker service ls
```

```tech
docker, swarm
```

```desc
#### 📋 서비스 복제본 상태 확인
`docker service ls`를 실행하여 `nginx-x3` 서비스의 복제본 상태를 확인합니다.

- **`REPLICAS`**: `3/3`으로 표시되면 요청한 3개의 컨테이너가 모두 정상적으로 실행 중임을 의미합니다.

> 💡 만약 `1/3`이나 `2/3`이라면, 아직 Swarm이 컨테이너를 생성 중인 상태일 수 있습니다.
```

**3) Manager Node: 3개 작업(Task) 상세 상태 확인**
`docker service ps` 명령어를 사용하여 3개의 작업이 각각 어느 노드에 분산되어 실행되고 있는지 확인합니다.

```bash
docker service ps nginx-x3
```

```tech
docker, swarm
```

```desc
#### 🔍 작업 분산 상태 확인
`nginx-x3` 서비스를 구성하는 3개의 작업(컨테이너)이 각각 어느 노드에 배포되었는지 확인합니다.

- **`docker service ps nginx-x3`**: `nginx-x3` 서비스의 모든 작업을 나열
- **`NODE`** 컬럼: 작업이 실행 중인 노드의 이름을 보여줌

> 💡 Swarm 스케줄러는 가��한 노드들에게 작업을 적절히 분산하여 배포합니다.
```

**4) Manager Node: 10초간 접속하여 로드 밸런싱 확인**
`watch`를 사용하여 10초 동안 1초마다 `nginx-x3` 서비스에 반복적으로 접속합니다. Swarm이 요청을 3개의 컨테이너로 분산시키므로, 매번 다른 컨테이너 호스트네임이 출력되는 것을 확인할 수 있습니다.

```bash
timeout 10s watch -n 1 curl http://192.168.0.2:8081
```

```tech
docker, swarm, nginx
```

```desc
#### ⚖️ 로드 밸런싱 테스트
서비스에 반복적으로 요청을 보내 Swarm의 내장 로드 밸런서가 트래픽을 여러 컨테이너로 분산시키는지 확인합니다.

- **`timeout 10s watch -n 1`**: 10초 동안 1초 간격으로 명령 반복
- **`curl ...`**: 서비스에 HTTP 요청 전송

> 💡 `curl` 요청에 대한 응답이 계속 바뀐다면, 이는 요청이 서로 다른 컨테이너로 전달되고 있음을 의미하며, 로드 밸런싱이 잘 동작하고 있다는 증거입니다.
```