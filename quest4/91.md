##### K8s: Pod 죽었을때 자동복구되는 Deployment 테스트 #####

**1) 테스트용 Deployment 생성**
```bash
kubectl create deployment nginx-healing-test --image=nginx --replicas=3
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🚀 테스트용 Deployment 생성
자동 복구(Self-healing) 기능을 테스트하기 위해 3개의 복제본을 가진 Nginx Deployment를 생성합니다.

- **`--replicas=3`**: 항상 3개의 Pod가 실행되도록 보장합니다.

> 💡 Deployment의 핵심 기능 중 하나는 선언된 상태(예: 복제본 3개)를 지속적으로 유지하는 것입니다.
```

**2) Deployment가 준비 될 때까지 wait**
```bash
kubectl wait --for=condition=available deployment/nginx-healing-test --timeout=60s
```
```tech
kubectl
```
```desc
#### ⏳ Deployment 준비 대기
생성된 Deployment의 모든 Pod들이 정상적으로 실행될 때까지 기다립니다.

- **`kubectl wait`**: 특정 조건이 충족될 때까지 대기합니다.
- **`--for=condition=available`**: 모든 복제본이 준비 상태가 될 때까지 기다립니다.

> 💡 테스트를 시작하기 전에 안정적인 상태에서 출발하는 것이 중요합니다.
```

**3) Pod 상태 모니터링**
```bash
timeout 10 watch kubectl get pods -l app=nginx-healing-test -o wide
```
```tech
bash,kubectl,kubernetes,watch
```
```desc
#### 👀 초기 Pod 상태 확인
10초 동안 현재 실행 중인 Pod 목록과 상태를 확인합니다.

- **`watch`**: 주기적으로 명령어를 실행하여 결과를 갱신합니다.
- 3개의 Pod가 모두 `Running` 상태인지 확인합니다.

> 💡 이 상태가 우리가 유지하고자 하는 '원하는 상태(Desired State)'입니다.
```

**4) 삭제할 Pod 이름 확인**
```bash
POD_NAME=$(kubectl get pods -l app=nginx-healing-test -o jsonpath='{.items[0].metadata.name}')
```
```tech
bash,echo,kubectl,kubernetes
```
```desc
#### 💾 삭제할 Pod 이름 변수 저장
임의로 삭제할 Pod 중 하나의 이름을 변수에 저장합니다.

- **`-o jsonpath='{.items[0].metadata.name}'`**: Pod 목록 중 첫 번째 Pod의 이름을 추출합니다.

> 💡 스크립트에서 특정 대상을 지정할 때 유용하게 사용됩니다.
```

```bash
echo "삭제할 Pod: $POD_NAME"
```
```tech
bash,echo,kubectl,kubernetes
```
```desc
#### 🗣️ 삭제 대상 Pod 이름 확인
변수에 저장된 Pod 이름을 출력하여 확인합니다.

- **`echo`**: 변수 값을 터미널에 보여줍니다.

> 💡 어떤 Pod가 삭제될지 미리 확인하여 실수를 방지합니다.
```

**5) Pod 강제 삭제**
```bash
kubectl delete pod $POD_NAME
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 💥 Pod 강제 삭제
장애 상황을 시뮬레이션하기 위해 실행 중인 Pod 하나를 강제로 삭제합니다.

- **`kubectl delete pod`**: 지정된 Pod를 삭제합니다.

> 💡 이 명령으로 Pod가 사라지면, Deployment는 복제본 개수가 2개로 줄어든 것을 감지합니다.
```

**6) 자동복구 확인**
```bash
timeout 10 watch kubectl get pods -l app=nginx-healing-test -o wide
```
```tech
bash,kubectl,kubernetes,watch
```
```desc
#### 🔄 자동 복구 과정 확인
Pod가 삭제된 후 어떤 변화가 일어나는지 10초 동안 실시간으로 관찰합니다.

- **`watch`**: 주기적으로 Pod 목록을 보여줍니다.

> 💡 삭제된 Pod는 `Terminating` 상태가 되고, Deployment는 즉시 새로운 Pod를 생성(`Pending` -> `ContainerCreating` -> `Running`)하여 복제본 개수 3개를 다시 맞추는 것을 볼 수 있습니다. 이것이 쿠버네티스의 강력한 자동 복구 기능입니다.
```

**7) 실습 자원 정리**
```bash
kubectl delete deployment nginx-healing-test
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🧹 실습 자원 정리
테스트에 사용된 Deployment를 삭제합니다.

- **`kubectl delete deployment`**: Deployment와 그에 속한 모든 리소스를 정리합니다.

> 💡 실습이 끝나면 항상 클러스터를 깨끗하게 정리하는 습관을 들이는 것이 좋습니다.
```

**8) 실습 종료**

```bash
: quit
```

```tech
bash,rocky
```

```desc
#### 👋 실습 종료
실습을 종료를 의미하는 `quit` 명령어를 실행합니다.
현재 터미널 세션을 종료합니다.

> 💡 모든 실습을 마친 후 사용합니다.
```