##### K8s: Service 연결 상태를 curl로 직접 테스트 #####

**1) 테스트용 Deployment 생성**
```bash
kubectl create deployment web-server --image=nginx --replicas=3
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🚀 테스트용 디플로이먼트 생성하기
3개의 Nginx 파드를 실행하는 `web-server` 디플로이먼트를 생성합니다.

- **`kubectl create deployment`**: 디플로이먼트 생성
- **`web-server`**: 디플로이먼트 이름
- **`--image=nginx`**: 사용할 컨테이너 이미지
- **`--replicas=3`**: 실행할 파드 개수

> 💡 `Deployment`는 여러 개의 동일한 파드를 관리하고, 파드에 문제가 생기면 자동으로 복구해주는 역할을 합니다.
```

**2) Deployment가 준비 될 때까지 wait**
```bash
kubectl wait --for=condition=available deployment/web-server --timeout=60s
```
```tech
kubectl
```
```desc
#### ⏳ 디플로이먼트 준비 대기
`web-server` 디플로이먼트의 모든 파드가 `Available`(사용 가능) 상태가 될 때까지 기다립니다.

- **`kubectl wait`**: 특정 조건이 충족될 때까지 대기
- **`--for=condition=available`**: `Available` 상태를 기다림
- **`deployment/web-server`**: 대상 디플로이먼트

> 💡 스크립트에서 리소스가 완전히 준비된 후 다음 단계를 진행하기 위해 필수적입니다.
```

**3) Deployment 상태 모니터링**
```bash
timeout 10 watch kubectl get deployment web-server
```
```tech
bash,kubectl,kubernetes,watch
```
```desc
#### 📊 디플로이먼트 상태 모니터링
`watch` 명령을 통해 10초간 `web-server` 디플로이먼트의 상태를 실시간으로 확인합니다.

- **`watch`**: 명령어를 주기적으로 반복 실행
- **`kubectl get deployment`**: 디플로이먼트 정보 조회
- **`timeout 10`**: 10초 후 자동 종료

> 💡 `READY` 컬럼을 통해 `3/3`과 같이 원하는 수의 파드가 모두 준비되었는지 확인할 수 있습니다.
```

**4) ClusterIP 타입의 Service 생성**
```bash
kubectl expose deployment web-server --port=80 --name=web-server-svc
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🔗 서비스(Service) 생성하기
`web-server` 디플로이먼트에 연결할 수 있는 내부 네트워크용 서비스를 생성합니다.

- **`kubectl expose deployment`**: 디플로이먼트를 외부에 노출
- **`--port=80`**: 서비스가 사용할 포트
- **`--name=web-server-svc`**: 서비스의 이름

> 💡 `ClusterIP` 타입의 서비스는 클러스터 내부에서만 접근 가능한 고유한 IP를 할당받아 여러 파드에 대한 단일 접근점을 제공합니다.
```

**5) Service 정보 확인**
```bash
kubectl get svc web-server-svc
```
```tech
bash,kubectl,kubernetes
```
```desc
#### ℹ️ 서비스 정보 확인하기
생성된 `web-server-svc` 서비스의 상세 정보를 확인합니다.

- **`kubectl get svc`**: 서비스 정보를 조회
- **`web-server-svc`**: 조회할 서비스 이름

> 💡 `CLUSTER-IP` 항목에 표시되는 IP가 이 서비스의 고유한 내부 주소입니다.
```

**6) Service IP 환경 변수 저장**
```bash
SERVICE_IP=$(kubectl get svc web-server-svc -o jsonpath='{.spec.clusterIP}')
```
```tech
bash,echo,kubectl,kubernetes
```
```desc
#### 💾 서비스 IP 주소 저장하기
`jsonpath`를 이용해 서비스의 `clusterIP`만 추출하여 `SERVICE_IP`라는 셸 변수에 저장합니다.

- **`-o jsonpath='...'`**: 출력 결과를 JSON 형식으로 보고 특정 필드 값을 추출
- **`{.spec.clusterIP}`**: 서비스의 ClusterIP에 해당하는 경로

> 💡 변수에 IP를 저장해두면 다음 명령어들에서 편리하게 사용할 수 있습니다.
```

```bash
echo "Service IP: $SERVICE_IP"
```
```tech
bash,echo,kubectl,kubernetes
```
```desc
#### ✅ 저장된 IP 주소 확인하기
`echo` 명령으로 `SERVICE_IP` 변수에 IP 주소가 올바르게 저장되었는지 확인합니다.

- **`echo`**: 변수나 문자열을 터미널에 출력

> 💡 다음 단계로 넘어가기 전에 값이 정확한지 검증하는 좋은 습관입니다.
```

**7) 임시 Pod를 이용한 Service 연결 테스트**
```bash
kubectl run tmp-curl --image=curlimages/curl --restart=Never --rm -i   --command -- curl http://$SERVICE_IP
```
```tech
bash,curl,kubectl,kubernetes
```
```desc
#### 🌐 임시 파드에서 서비스 연결 테스트
`curl` 명령어가 포함된 임시 파드를 실행하여 서비스 IP로 HTTP 요청을 보내고 연결을 테스트합니다.

- **`kubectl run tmp-curl`**: 임시 파드 생성 및 실행
- **`--image=curlimages/curl`**: `curl`이 설치된 이미지 사용
- **`--rm`**: 명령 실행 후 파드 자동 삭제
- **`-- curl http://$SERVICE_IP`**: 파드 내부에서 `curl`로 서비스에 요청

> 💡 "Welcome to nginx!" 메시지가 보이면 클러스터 내부에서 서비스가 정상적으로 동작함을 의미합니다.
```

**8) Service 로드 밸런싱 확인**
```bash
kubectl run tmp-curl --image=curlimages/curl --restart=Never --rm -i --command -- sh -c "for i in \$(seq 1 10); do echo -n \"Request \$i: \"; curl -s --connect-timeout 1 http://$SERVICE_IP | grep -o 'Welcome to nginx\!'; sleep 1; done"
```
```tech
awk,bash,curl,grep,kubectl,kubernetes,seq,sh
```
```desc
#### ⚖️ 서비스 로드 밸런싱 확인하기
임시 파드에서 1초 간격으로 10번의 요청을 보내 서비스가 3개의 백엔드 파드로 트래픽을 분산하는지 확인합니다.

- **`for i in $(seq 1 10)`**: 10번 반복하는 셸 루프
- **`curl ...`**: 서비스에 요청을 보냄
- **`grep ...`**: 응답에서 `Welcome to nginx!` 문자열만 필터링

> 💡 모든 요청이 성공하면, 서비스가 요청을 여러 파드에 안정적으로 분배(로드 밸런싱)하고 있음을 알 수 있습니다.
```


**9) Deployment 삭제**
```bash
kubectl delete deployment web-server
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🧹 디플로이먼트 삭제하기
실습에 사용된 `web-server` 디플로이먼트를 삭제합니다.

- **`kubectl delete deployment`**: 디플로이먼트 삭제
- 삭제 시 디플로이먼트가 관리하던 파드들도 함께 제거됩니다.

> 💡 불필요한 리소스는 정리하여 클러스터를 깨끗하게 유지합니다.
```

**10) Service 삭제**
```bash
kubectl delete service web-server-svc
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🧹 서비스 삭제하기
실습에 사용된 `web-server-svc` 서비스를 삭제합니다.

- **`kubectl delete service`**: 서비스 삭제

> 💡 디플로이먼트와 서비스를 모두 삭제하여 실습 전 상태로 되돌립니다.
```
