##### K8s: CoreDNS 장애 재현 및 복구#####

**1) 웹 애플리케이션 Deployment YAML 생성**

```bash
kubectl create deployment web-deploy --image=reallinux/web-server:3 --replicas=1 --dry-run=client -o yaml > web-deploy.yaml
```

```tech
kubectl,deployment,yaml,generate,k8s,bash
```

```desc
#### 📝 Deployment YAML 생성
`web-deploy`라는 이름으로 웹 서버 파드를 1개 실행하는 디플로이먼트를 정의합니다.

- `--image`: 컨테이너 이미지 (`reallinux/web-server:3`)  
- `--replicas=1`: 파드 수 1개로 설정  
- `--dry-run=client`: 실제 반영하지 않고 YAML 생성만 수행  
- `-o yaml > web-deploy.yaml`: YAML 파일로 저장  

> 💡 실제 적용 전, YAML 템플릿을 안전하게 생성하는 방법입니다.
```

**2) 생성된 YAML 파일 확인**

```bash
cat web-deploy.yaml
```

```tech
cat,yaml,k8s,bash
```

```desc
#### 📖 Deployment YAML 내용 확인
`web-deploy.yaml` 파일을 열어 디플로이먼트 정의를 확인합니다.

- 주요 필드: `metadata.name`, `spec.replicas`, `containers.image`  
- 여기서 설정된 값이 실제 파드 배포 시 반영됩니다.

> 💡 쿠버네티스 리소스를 YAML로 직접 관리하는 습관을 들이면 유지보수가 편리합니다.
```

**3) 디플로이먼트 적용**

```bash
kubectl apply -f web-deploy.yaml
```

```tech
kubectl,apply,deployment,k8s,bash
```

```desc
#### 🚀 디플로이먼트 배포
앞에서 생성한 `web-deploy.yaml`을 적용해 파드를 실제로 실행합니다.

- 기대 결과: `deployment.apps/web-deploy created`  
- 이후 파드가 Running 상태로 기동됩니다.
```

**4) 서비스 YAML 생성**

```bash
kubectl expose deployment web-deploy --port=80 --target-port=80 --name=web-svc --dry-run=client -o yaml > web-svc.yaml
```

```tech
kubectl,expose,service,yaml,k8s,bash
```

```desc
#### 🌐 서비스 YAML 생성
`web-deploy`를 대상으로 ClusterIP 서비스 `web-svc`를 정의합니다.

- `--port=80`: 서비스 포트  
- `--target-port=80`: 컨테이너 포트  
- `--name=web-svc`: 서비스 이름  
- `--dry-run=client -o yaml`: YAML만 생성 후 저장  

> 💡 파드 IP는 변동되므로 서비스로 안정적인 접근점을 제공합니다.
```

**5) 생성된 서비스 YAML 파일 확인**

```bash
cat web-svc.yaml
```

```tech
cat,yaml,k8s,bash
```

```desc
#### 📖 서비스 YAML 확인
생성된 `web-svc.yaml` 내용을 출력하여 확인합니다.

- 필드: `kind: Service`, `spec.ports`, `spec.selector`  
- 파드와 서비스가 어떻게 매핑되는지 확인 가능합니다.
```

**6) 서비스 적용**

```bash
kubectl apply -f web-svc.yaml
```

```tech
kubectl,apply,service,k8s,bash
```

```desc
#### 🚀 서비스 배포
서비스를 클러스터에 적용해 파드 앞단에 접근 가능한 ClusterIP를 생성합니다.

- 기대 결과: `service/web-svc created`  
- DNS 이름: `web-svc.default.svc.cluster.local`  
```

**7) 현재 리소스 상태 확인**

```bash
sleep 5 && kubectl get all
```

```tech
kubectl,get,all,k8s,bash
```

```desc
#### 📊 전체 리소스 확인
잠시 대기 후 현재 파드, 서비스, 디플로이먼트의 상태를 출력합니다.

- Running 상태의 파드(web-deploy)  
- ClusterIP 타입의 서비스(web-svc)  

> 💡 정상 환경에서 DNS 조회 및 서비스 접근이 가능해야 합니다.
```

**8) CoreDNS 상태 확인**

```bash
kubectl -n kube-system get deploy coredns
```

```tech
kubectl,get,coredns,k8s,bash
```

```desc
#### 🧩 CoreDNS 디플로이먼트 상태 확인
쿠버네티스 네트워크의 DNS 서버 역할을 하는 CoreDNS의 상태를 확인합니다.

- 정상: `AVAILABLE` 파드 수 > 0  
- CoreDNS는 모든 서비스 DNS 해석을 담당합니다.
```

**9) DNS 테스트용 pod 생성**

```bash
kubectl run dns-test --image=curlimages/curl:8.8.0 --restart=Never -- sleep 3600
```

```tech
kubectl,run,pod,dns-test,k8s,bash
```

```desc
#### 🧪 테스트 pod 실행
DNS 확인을 위해 `curl` 이미지를 사용한 단발성 파드를 생성합니다.

- `--restart=Never`: 잡 형태 파드로 실행  
- `sleep 3600`: 파드가 1시간 동안 대기  

> 💡 독립적인 테스트 환경을 제공하여 CoreDNS와 서비스 접근을 확인합니다.
```

**10) 테스트 pod 준비 대기**

```bash
kubectl wait --for=condition=Ready pod/dns-test --timeout=60s
```

```tech
kubectl,wait,pod,k8s,bash
```

```desc
#### ⏳ 파드 준비 대기
`dns-test` 파드가 Running/Ready 상태가 될 때까지 기다립니다.

- `--for=condition=Ready`: 파드 준비 상태 확인  
- `--timeout=60s`: 60초 내 대기  
```

**11) 정상 DNS 조회 및 서비스 접근 확인**

```bash
kubectl exec -it dns-test -- curl http://web-svc.default.svc.cluster.local
```

```tech
kubectl,exec,curl,dns,k8s,bash
```

```desc
#### ✅ 정상 상태에서 서비스 접근
`dns-test` 파드 내부에서 `curl`을 통해 서비스 DNS로 접근합니다.

- 기대 결과: 웹 서버 응답(HTML 소스 등) 정상 출력  
- CoreDNS가 정상 동작하면 서비스 이름으로 통신 가능합니다.
```

**12) CoreDNS 중지 (장애 재현)**

```bash
kubectl -n kube-system scale deploy coredns --replicas=0
```

```tech
kubectl,scale,coredns,disable,k8s,bash
```

```desc
#### 💥 CoreDNS 문제상황 유발
CoreDNS 파드 개수를 0으로 줄여 DNS 서버를 중지시킵니다.

- DNS 해석 불가 상태 발생  
- 서비스 이름을 통한 접근이 모두 실패해야 정상적인 장애 재현입니다.
```

**13) CoreDNS 상태 확인 (중지 후)**

```bash
kubectl -n kube-system get deploy coredns
```

```tech
kubectl,get,coredns,k8s,bash
```

```desc
#### 📉 CoreDNS 비활성 상태 확인
CoreDNS의 파드 수가 0으로 표시되며 중지되었음을 확인합니다.
```

**14) CoreDNS 장애 상황에서 서비스 접근 시도**

```bash
kubectl exec -it dns-test -- curl http://web-svc.default.svc.cluster.local
```

```tech
kubectl,exec,curl,dns-fail,k8s,bash
```

```desc
#### ❌ DNS 장애 확인
CoreDNS가 꺼진 상태에서 DNS 기반 서비스 이름 접근을 시도합니다.

- 기대 결과: DNS 해석 실패 (`Could not resolve host`)  
- 직접 Pod IP로는 접근 가능하지만 DNS 기반 이름은 불가능합니다.
```

**15) CoreDNS 복구**

```bash
kubectl -n kube-system scale deploy coredns --replicas=1
```

```tech
kubectl,scale,coredns,enable,k8s,bash
```

```desc
#### 🔄 CoreDNS 복구
CoreDNS 파드 개수를 다시 1개로 늘려 DNS 서버를 복원합니다.
```

**16) CoreDNS 복구 상태 확인**

```bash
sleep 3 && kubectl -n kube-system get deploy coredns
```

```tech
kubectl,get,coredns,recovery,k8s,bash
```

```desc
#### 📈 CoreDNS 정상화 확인
잠시 대기 후 CoreDNS 파드가 Running 상태로 복구되었는지 확인합니다.
```

**17) DNS 기반 서비스 접근 재확인**

```bash
kubectl exec -it dns-test -- curl http://web-svc.default.svc.cluster.local
```

```tech
kubectl,exec,curl,dns-success,k8s,bash
```

```desc
#### ✅ 복구 후 정상 동작 확인
CoreDNS가 복구되면 다시 서비스 이름으로 접근이 정상 동작합니다.

- 기대 결과: 웹 서버 응답이 정상적으로 출력  
- 장애 → 실패 → 복구 → 정상 동작 흐름을 체험할 수 있습니다.
```

**18) 실습 종료**

```bash
: quit
```

```tech
bash,rocky
```

```desc
#### 👋 실습 종료
실습을 종료를 의미하는 `quit` 명령어를 실행합니다.  
현재 터미널 세션을 종료합니다.

```
