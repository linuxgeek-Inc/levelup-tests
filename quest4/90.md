##### K8s: 웹서버 Deployment 롤링 업데이트 방법 #####

**1) 초기 버전 Deployment 배포**
```bash
kubectl create deployment nginx-rolling-deployment --image=nginx:1.25.0 --replicas=3
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🚀 초기 버전 Deployment 배포
롤링 업데이트를 테스트하기 위해 특정 버전(1.25.0)의 Nginx 이미지를 사용하는 Deployment를 생성합니다.

- **`--image=nginx:1.25.0`**: Nginx 이미지의 특정 버전을 명시합니다.
- **`--replicas=3`**: 3개의 복제본을 생성합니다.

> 💡 롤링 업데이트는 서비스 중단 없이 애플리케이션을 새로운 버전으로 점진적으로 교체하는 방식입니다.
```

**2) Deployment가 준비 될 때까지 wait**
```bash
kubectl wait --for=condition=available deployment/nginx-rolling-deployment --timeout=60s
```
```tech
kubectl
```
```desc
#### ⏳ Deployment 준비 대기
초기 버전의 Deployment가 완전히 준비될 때까지 기다립니다.

- **`kubectl wait`**: 특정 조건이 충족될 때까지 대기합니다.
- **`--for=condition=available`**: 모든 복제본이 준비 상태가 될 때까지 기다립니다.

> 💡 업데이트를 시작하기 전에 시스템이 안정적인 상태인지 확인하는 것이 중요합니다.
```

**3) Deployment 상태 확인**
```bash
kubectl get deployment nginx-rolling-deployment
```
```tech
bash,kubectl,kubernetes
```
```desc
#### ✅ Deployment 상태 확인
배포된 Deployment의 상태를 확인하여 모든 복제본이 정상적으로 실행 중인지 확인합니다.

- **`READY`** 컬럼이 `3/3`인지 확인합니다.

> 💡 이 시점에서는 모든 Pod가 초기 버전(1.25.0)으로 실행되고 있습니다.
```

**4) Pod 이미지 버전 확인**
```bash
kubectl get pods -l app=nginx-rolling-deployment -o wide
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🏷️ Pod 이미지 버전 확인
실행 중인 Pod들의 컨테이너 이미지 버전을 확인합니다.

- **`-o wide`** 옵션을 사용하면 `IMAGE` 컬럼이 보이지 않으므로, 실제로는 `kubectl describe pod`나 `jsonpath`를 사용해야 더 정확히 확인할 수 있습니다. (이 예제에서는 다음 단계와 비교하기 위함)

> 💡 모든 Pod가 `nginx:1.25.0` 이미지를 사용하고 있어야 합니다.
```

**5) 롤링 업데이트 시작**
```bash
kubectl set image deployment/nginx-rolling-deployment nginx=nginx:1.25.1
```
```tech
bash,kubectl,kubernetes
```
```desc
#### ⬆️ 롤링 업데이트 시작
Deployment의 컨테이너 이미지를 새로운 버전(1.25.1)으로 변경하여 롤링 업데이트를 실행합니다.

- **`kubectl set image`**: Deployment의 컨테이너 이미지를 업데이트하는 명령어입니다.
- **`deployment/nginx-rolling-deployment`**: 대상 Deployment입니다.
- **`nginx=nginx:1.25.1`**: `nginx`라는 이름의 컨테이너 이미지를 `nginx:1.25.1` 버전으로 변경합니다.

> 💡 이 명령을 실행하면 쿠버네티스가 정해진 전략에 따라 구버전 Pod를 점진적으로 신버전 Pod로 교체하기 시작합니다.
```

**6) Pod 상태 변화 관찰**
```bash
timeout 10 watch kubectl get pods -l app=nginx-rolling-deployment -o wide
```
```tech
bash,kubectl,kubernetes,watch
```
```desc
#### 🔄 Pod 상태 변화 관찰
롤링 업데이트가 진행되는 동안 Pod들의 상태 변화를 10초간 실시간으로 지켜봅니다.

- **`watch`**: 주기적으로 Pod 목록을 갱신하여 보여줍니다.

> 💡 새로운 버전의 Pod가 `ContainerCreating` -> `Running` 상태로 변하고, 구버전의 Pod가 `Terminating` 상태로 바뀌는 과정을 볼 수 있습니다.
```

**7) 업데이트 상태 확인**
```bash
kubectl rollout status deployment/nginx-rolling-deployment
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 📊 업데이트 상태 확인
롤링 업데이트의 진행 상태를 확인합니다.

- **`kubectl rollout status`**: 배포(rollout)의 현재 상태를 추적하여 보여줍니다.
- "successfully rolled out" 메시지가 나타나면 업데이트가 성공적으로 완료된 것입니다.

> 💡 업데이트가 실패하거나 멈추면 이 명령어를 통해 상태를 확인할 수 있습니다.
```

**8) 업데이트 결과 확인**
```bash
kubectl get pods -l app=nginx-rolling-deployment -o yaml | grep "image: nginx"
```
```tech
bash,grep,kubectl,kubernetes,yaml
```
```desc
#### ✅ 업데이트 결과 확인
모든 Pod들이 새로운 이미지 버전으로 교체되었는지 확인합니다.

- **`-o yaml`**: Pod 정보를 YAML 형식으로 출력합니다.
- **`| grep "image: nginx"`**: 출력된 내용 중에서 "image: nginx"가 포함된 줄만 필터링합니다.

> 💡 모든 Pod의 이미지 버전이 `nginx:1.25.1`로 변경되었는지 확인합니다.
```

**9) 업데이트 기록 확인**
```bash
kubectl rollout history deployment/nginx-rolling-deployment
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 📜 업데이트 기록 확인
Deployment의 배포 이력(revision)을 확인합니다.

- **`kubectl rollout history`**: Deployment의 변경 이력을 보여줍니다.
- 각 리비전은 이미지 변경 등의 업데이트 내역을 담고 있습니다.

> 💡 이 기록을 사용하여 이전 버전으로 롤백할 수 있습니다.
```

**10) 이전 버전으로 롤백**
```bash
kubectl rollout undo deployment/nginx-rolling-deployment
```
```tech
bash,kubectl,kubernetes
```
```desc
#### ⏪ 이전 버전으로 롤백
문제가 발생했을 때 Deployment를 이전 리비전(버전)으로 되돌립니다.

- **`kubectl rollout undo`**: 이전 배포 상태로 롤백합니다.

> 💡 특정 리비전으로 돌아가고 싶다면 `--to-revision=<번호>` 옵션을 사용할 수 있습니다.
```

**11) 롤백 후 상태 확인**
```bash
kubectl rollout status deployment/nginx-rolling-deployment
```
```tech
bash,kubectl,kubernetes
```
```desc
#### ⏪ 롤백 후 상태 확인
롤백이 성공적으로 완료되었는지 확인합니다.

- "successfully rolled out" 메시지가 출력되면 롤백이 완료된 것입니다.
- 이제 Pod들은 다시 이전 버전(1.25.0)으로 돌아갑니다.

> 💡 롤백 과정도 롤링 업데이트와 동일한 방식으로 서비스 중단 없이 진행됩니다.
```

**12) 실습 자원 정리**
```bash
kubectl delete deployment nginx-rolling-deployment
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🗑 실습 자원 정리
실습에 사용된 Deployment를 삭제합니다.

- **`kubectl delete deployment`**: Deployment와 관련된 모든 리소스를 삭제합니다.

> 💡 실습 후에는 항상 리소스를 정리하는 것이 좋습니다.
```

**13) 실습 종료**

```bash
: quit
```

```tech
bash,rocky
```

```desc
#### 👋 실습 종료
실습을 종료를 의미하는 `quit` 명령어를 실행합니다.
현재 터미널 세션을 종료합니다.

> 💡 모든 실습을 마친 후 사용합니다.
```