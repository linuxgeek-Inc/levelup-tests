##### Swarm: μ„λΉ„μ¤ Taskκ°€ μ£½μ—μ„ λ• μλ™ λ³µκµ¬ λ°©λ²• #####

> **μ°Έκ³ :** μ΄ μ‹¤μµμ—μ„λ” μ‘μ—…μ λ…Έλ“ IPλ΅ `192.168.0.3`μ„ μ‚¬μ©ν•©λ‹λ‹¤. μ‹¤μ  ν™κ²½μ— λ§κ² IP μ£Όμ†λ¥Ό λ³€κ²½ν•μ—¬ μ‹¤ν–‰ν•μ„Έμ”.

**1) Manager Node: λ³µκµ¬ ν…μ¤νΈμ© μ„λΉ„μ¤ μƒμ„±**
μλ™ λ³µκµ¬ κΈ°λ¥μ„ ν…μ¤νΈν•κΈ° μ„ν•΄ 2κ°μ λ³µμ λ³Έμ„ κ°€μ§„ `nginx-recover` μ„λΉ„μ¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤.

```bash
docker service create --name nginx-recover --replicas 2 --publish published=8083,target=80 nginx
```

```tech
docker, swarm, nginx
```

```desc
#### π€ λ³µκµ¬ ν…μ¤νΈμ© μ„λΉ„μ¤ μƒμ„±
Swarmμ μλ™ λ³µκµ¬(Self-healing) κΈ°λ¥μ„ μ‹ν—ν•κΈ° μ„ν• Nginx μ„λΉ„μ¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤.

- **`--replicas 2`**: 2κ°μ μ»¨ν…μ΄λ„λ¥Ό μ‹¤ν–‰ν•λ„λ΅ μ„¤μ •
- **`--name nginx-recover`**: μ„λΉ„μ¤μ λ©μ μ„ μ•κΈ° μ‰½κ² μ΄λ¦„ μ§€μ •

> π’΅ μΌλ¶€λ¬ μ»¨ν…μ΄λ„λ¥Ό μ¤‘μ§€μ‹μΌμ„ Swarmμ΄ μ•½μ†λ μƒνƒ(`replicas 2`)λ¥Ό μ μ§€ν•κΈ° μ„ν•΄ μ–΄λ–»κ² λ°μ‘ν•λ”μ§€ κ΄€μ°°ν•  κ²ƒμ…λ‹λ‹¤.
```

**2) Manager Node: Worker Nodeμ—μ„ μ‹¤ν–‰ μ¤‘μΈ Task μ»¨ν…μ΄λ„ ID ν™•μΈ**
`docker service ps`λ¥Ό μ‚¬μ©ν•μ—¬ μ‘μ—…μ λ…Έλ“(192.168.0.3)μ—μ„ μ‹¤ν–‰ μ¤‘μΈ `nginx-recover` μ»¨ν…μ΄λ„μ IDλ¥Ό ν™•μΈν•©λ‹λ‹¤. (λ§μ•½ Workerκ°€ μ•„λ‹ Managerμ—μ„ 2κ° λ¨λ‘ μ‹¤ν–‰λλ‹¤λ©΄, `docker service update --force nginx-recover`λ΅ μ¬λ°°μΉ)

```bash
docker service ps nginx-recover
```

```tech
docker, swarm
```

```desc
#### π” μ¤‘μ§€μ‹ν‚¬ μ»¨ν…μ΄λ„(Task) ν™•μΈ
`docker service ps`λ¥Ό μ‚¬μ©ν•μ—¬ ν„μ¬ μ‹¤ν–‰ μ¤‘μΈ μ‘μ—…(μ»¨ν…μ΄λ„)μ λ©λ΅κ³Ό μ„μΉλ¥Ό ν™•μΈν•©λ‹λ‹¤.

- **`docker service ps nginx-recover`**: `nginx-recover` μ„λΉ„μ¤μ μ‘μ—… λ©λ΅μ„ ν‘μ‹
- **`NODE`** μ»¬λΌ: μ‘μ—…μ΄ μ‹¤ν–‰ μ¤‘μΈ λ…Έλ“λ¥Ό ν™•μΈ

> π’΅ μ–΄λ–¤ λ…Έλ“μ μ»¨ν…μ΄λ„λ¥Ό μ¤‘μ§€μ‹ν‚¬μ§€ λ―Έλ¦¬ νμ•…ν•λ” λ‹¨κ³„μ…λ‹λ‹¤.
```

**3) Worker Node: μ»¨ν…μ΄λ„ κ°•μ  μΆ…λ£**
μ‘μ—…μ λ…Έλ“(192.168.0.3)μ— μ ‘μ†ν•μ—¬, μ΄μ „ λ‹¨κ³„μ—μ„ ν™•μΈν• μ»¨ν…μ΄λ„ IDλ¥Ό μ‚¬μ©ν•μ—¬ `docker kill` λ…λ ΉμΌλ΅ μ»¨ν…μ΄λ„λ¥Ό κ°•μ λ΅ μΆ…λ£μ‹ν‚µλ‹λ‹¤.

```bash
docker kill $(docker ps --filter "name=nginx-recover" -q)
```

```tech
docker, swarm
```

```desc
#### π’¥ μ»¨ν…μ΄λ„ κ°•μ  μΆ…λ£
`docker kill` λ…λ Ήμ„ μ‚¬μ©ν•μ—¬ ν…μ¤νΈμ© μ»¨ν…μ΄λ„ μ¤‘ ν•λ‚λ¥Ό μλ„μ μΌλ΅ μ¤‘μ§€μ‹ν‚µλ‹λ‹¤.

- **`docker kill`**: μ‹¤ν–‰ μ¤‘μΈ μ»¨ν…μ΄λ„μ— μΆ…λ£ μ‹ νΈλ¥Ό λ³΄λ‚΄ κ°•μ λ΅ μ¤‘λ‹¨
- **`$(...)`**: οΏ½οΏ½νΈ μ•μ λ…λ Ή κ²°κ³Όλ¥Ό `docker kill`μ μΈμλ΅ μ‚¬μ©
- **`docker ps ... -q`**: νΉμ • μ΄λ¦„μ μ»¨ν…μ΄λ„ IDλ§ μ¶λ ¥

> π’΅ μ΄ λ…λ Ήμ€ μ‘μ—…μ λ…Έλ“μ—μ„ μ§μ ‘ μ‹¤ν–‰ν•μ—¬, ν•΄λ‹Ή λ…Έλ“μ μ»¨ν…μ΄λ„λ¥Ό μ¤‘μ§€μ‹ν‚¤λ” μƒν™©μ„ μ‹λ®¬λ μ΄μ…ν•©λ‹λ‹¤.
```

**4) Manager Node: μ„λΉ„μ¤ μƒνƒ λ³€ν™” λ° μλ™ λ³µκµ¬ λ¨λ‹ν„°λ§**
κ΄€λ¦¬μ λ…Έλ“μ—μ„ `watch`λ¥Ό μ‚¬μ©ν•μ—¬ `nginx-recover` μ„λΉ„μ¤μ μƒνƒλ¥Ό μ‹¤μ‹κ°„μΌλ΅ ν™•μΈν•©λ‹λ‹¤. μΆ…λ£λ Taskλ” `Shutdown` μƒνƒκ°€ λκ³ , Swarm μ¤μΌ€μ¤„λ¬κ°€ μ¦‰μ‹ μƒλ΅μ΄ Taskλ¥Ό μƒμ„±ν•μ—¬ `Running` μƒνƒλ΅ λ§λ“λ” κ²ƒμ„ λ³Ό μ μμµλ‹λ‹¤.

```bash
timeout 10 watch docker service ps nginx-recover
```

```tech
docker, swarm
```

```desc
#### β±οΈ μλ™ λ³µκµ¬ κ³Όμ • λ¨λ‹ν„°λ§
`watch`λ¥Ό μ‚¬μ©ν•μ—¬ μ»¨ν…μ΄λ„κ°€ μ¤‘μ§€λ ν›„ Swarmμ΄ μ–΄λ–»κ² λ°μ‘ν•λ”μ§€ μ‹¤μ‹κ°„μΌλ΅ κ΄€μ°°ν•©λ‹λ‹¤.

- **`watch docker service ps ...`**: μ„λΉ„μ¤μ μ‘μ—… μƒνƒλ¥Ό κ³„μ†ν•΄μ„ ν™•μΈ
- **`Shutdown`**: λ°©κΈ `kill`ν• μ»¨ν…μ΄λ„μ μƒνƒ
- **`Preparing` -> `Running`**: Swarmμ΄ λ€μ²΄ν•  μƒ μ»¨ν…μ΄λ„λ¥Ό μƒμ„±ν•κ³  μ‹¤ν–‰ν•λ” κ³Όμ •

> π’΅ κ΄€λ¦¬μκ°€ μ§μ ‘ κ°μ…ν•μ§€ μ•μ•„λ„ Swarmμ΄ μ¤μ¤λ΅ λ¬Έμ λ¥Ό κ°μ§€ν•κ³  λ³µκµ¬ν•λ” κ²ƒμ„ λ³Ό μ μμµλ‹λ‹¤.
```

**5) Manager Node: μµμΆ… λ³µοΏ½οΏ½οΏ½ μƒνƒ ν™•μΈ**
μ μ‹ ν›„, `REPLICAS`κ°€ λ‹¤μ‹ `2/2`λ΅ λ³µκµ¬λμ—λ”μ§€ ν™•μΈν•μ—¬ Swarmμ μλ™ λ³µκµ¬ κΈ°λ¥μ΄ μ •μƒμ μΌλ΅ λ™μ‘ν–μμ„ μ¦λ…ν•©λ‹λ‹¤.

```bash
docker service ls
```

```tech
docker, swarm
```

```desc
#### β… μµμΆ… λ³µκµ¬ μƒνƒ ν™•μΈ
`docker service ls`λ¥Ό ν†µν•΄ μ„λΉ„μ¤μ λ³µμ λ³Έ μκ°€ λ‹¤μ‹ `2/2`λ΅ λμ•„μ™”λ”μ§€ μµμΆ… ν™•μΈν•©λ‹λ‹¤.

- **`REPLICAS`**: `2/2`λ” μ„λΉ„μ¤κ°€ λ‹¤μ‹ μ •μƒ μƒνƒλ΅ λ³µκµ¬λμ—μμ„ μλ―Έ

> π’΅ μ΄λ΅μ¨ Swarmμ€ ν΄λ¬μ¤ν„°μ μƒνƒλ¥Ό μ„ μ–Έλ λ€λ΅(desired state) μ μ§€ν•λ ¤λ” νΉμ§•μ΄ μμμ„ μ• μ μμµλ‹λ‹¤.
```