##### K8s: 쿠버네티스 설치와 worker 등록 방법 #####


**1) Master Node에 접속**

```bash
ssh 192.168.0.2
```
```tech
ssh
```

```desc
#### 🖥️ 마스터 노드 접속
SSH를 사용하여 쿠버네티스 클러스터의 마스터 역할을 할 서버에 접속합니다.

- **`ssh`**: 원격 서버에 안전하게 접속하기 위한 명령어
- **`192.168.0.2`**: 접속할 마스터 노드의 IP 주소

> 💡 클러스터의 모든 관리와 제어는 마스터 노드에서 시작됩니다.
```

**2) Master Node에 K3s 설치**

```bash
curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644
```
```tech
bash,curl,k3s,kubernetes,sh
```

```desc
#### 🚀 K3s 마스터 노드 설치
경량 쿠버네티스인 K3s를 마스터 노드에 설치합니다.

- **`curl -sfL ...`**: K3s 설치 스크립트를 다운로드
- **`| sh -s -`**: 다운로드한 스크립트를 바로 실행
- **`--write-kubeconfig-mode 644`**: 생성되는 `kubeconfig` 파일의 권한을 설정하여 `kubectl`을 바로 사용할 수 있게 함

> 💡 K3s는 설치가 간단하고 가벼워 학습용이나 소규모 환경에 적합합니다.
```

**3) Master Node 정상 작동 확인**

* 참고: 전부 다 Running이나 Completed 되면 정상 작동 완료

```bash
timeout 30 watch kubectl get pods -A
```
```tech
kubernetes
```

```desc
#### ✅ 설치 확인 및 시스템 파드 모니터링
K3s가 성공적으로 설치되고 시스템 파드들이 정상적으로 실행되는지 확인합니다.

- **`timeout 30`**: 30초 후에 명령어 실행을 중단
- **`watch kubectl get pods -A`**: 모든 네임스페이스(`-A`)의 파드 상태를 2초 간격으로 계속해서 보여줌

> 💡 모든 파드가 `Running` 또는 `Completed` 상태가 되면 마스터 노드가 준비된 것입니다.
```

**4) 토큰 복사하기**

```bash
sudo cp /var/lib/rancher/k3s/server/node-token ~/
```
```tech
cp, kubernetes
```

```desc
#### 🔑 워커 노드 참여 토큰 복사
워커 노드가 마스터 노드에 합류할 때 필요한 비밀 토큰을 홈 디렉터리로 복사합니다.

- **`sudo cp`**: 관리자 권한으로 파일을 복사
- **`/var/lib/rancher/k3s/server/node-token`**: K3s가 생성한 토큰 파일의 위치
- **`~/`**: 현재 사용자의 홈 디렉터리

> 💡 이 토큰은 워커 노드가 클러스터의 일원임을 인증하는 데 사용됩니다.
```

**5) scp에서 복사할 수 있도록 토큰 파일 권한 변경하기**

```bash
sudo chown reallinux:reallinux ~/node-token
```
```tech
chown
```

```desc
#### 🔒 토큰 파일 권한 변경
`scp`를 사용하여 다른 노드에서 접근할 수 있도록 복사한 토큰 파일의 소유자를 변경합니다.

- **`sudo chown`**: 파일의 소유자 및 그룹을 변경
- **`reallinux:reallinux`**: 변경할 사용자:그룹
- **`~/node-token`**: 대상 파일

> 💡 `root` 소유의 파일을 일반 사용자가 원격으로 복사하려면 이처럼 권한 조정이 필요합니다.
```

**6) Master Node 접속 종료**

```bash
exit
```
```tech
ssh
```

```desc
#### 🚪 마스터 노드에서 나가기
마스터 노드에서의 설정을 마치고 SSH 연결을 종료합니다.

- **`exit`**: 현재 셸 세션 종료

> 💡 이제 워커 노드에 접속하여 클러스터에 참여시킬 차례입니다.
```

**7) Worker Node에 접속**

```bash
ssh 192.168.0.3
```
```tech
ssh
```

```desc
#### 🖥️ 워커 노드 접속
클러스터에서 실제 작업을 수행할 워커 노드에 접속합니다.

- **`ssh`**: 원격 서버 접속 명령어
- **`192.168.0.3`**: 접속할 워커 노드의 IP 주소

> 💡 워커 노드는 마스터 노드의 지시를 받아 파드(컨테이너)를 실행하는 역할을 합니다.
```

**8) Master Node 토큰 복사**

* 참고: scp로 Master Node에서 토큰 복사해서 Worker 노드 등록할때 활용

```bash
scp reallinux@192.168.0.2:~/node-token ./
```
```tech
scp, kubernetes
```

```desc
#### 📂 마스터 노드에서 토큰 가져오기
`scp`를 사용하여 마스터 노드에 준비해 둔 참여 토큰 파일을 현재 워커 노드로 가져옵니다.

- **`scp`**: 원격 서버와 파일을 안전하게 복사
- **`reallinux@192.168.0.2:~/node-token`**: 마스터 노드에 있는 토큰 파일의 위치
- **`./`**: 현재 디렉터리에 복사

> 💡 이 토큰을 사용하여 K3s 에이전트를 설치하고 클러스터에 참여합니다.
```

**9) Worker Node에 k3s agent 설치**

```bash
curl -sfL https://get.k3s.io | \
  K3S_URL=https://192.168.0.2:6443 \
  K3S_TOKEN=$(cat ~/node-token) \
  sh -
```
```tech
cat, kubernetes, curl
```

```desc
#### 🤝 K3s 에이전트 설치 및 클러스터 참여
워커 노드에 K3s 에이전트를 설치하고, 토큰을 사용하여 기존 클러스터에 합류시킵니다.

- **`K3S_URL=...`**: 접속할 마스터 노드의 API 서버 주소를 지정
- **`K3S_TOKEN=...`**: 클러스터 참여에 사용할 토큰을 지정
- **`sh -`**: 다운로드한 스크립트를 위 환경변수들과 함께 실행

> 💡 "This node has joined the cluster"와 유사한 메시지가 나오면 성공입니다.
```

**10) Worker Node 접속 종료**

```bash
exit
```
```tech
ssh
```

```desc
#### 🚪 워커 노드에서 나가기
워커 노드 설정을 마친 후 SSH 연결을 종료합니다.

- **`exit`**: 현재 셸 세션 종료

> 💡 이제 다시 마스터 노드로 돌아가 클러스터 상태를 최종 확인할 차례입니다.
```

**11) Master Node에 접속**

```bash
ssh 192.168.0.2
```
```tech
ssh
```

```desc
#### 🖥️ 마스터 노드로 복귀
클러스터에 워커 노드가 잘 등록되었는지 확인하기 위해 다시 마스터 노드로 접속합니다.

- **`ssh`**: 원격 서버 접속 명령어
- **`192.168.0.2`**: 마스터 노드의 IP 주소

> 💡 클러스터의 전체 상태 확인은 항상 마스터 노드에서 수행합니다.
```

**12) 복사해 두었던 토큰 삭제**

```bash
rm ~/node-token
```
```tech
rm
```

```desc
#### 🗑️ 임시 토큰 파일 삭제
보안을 위해 사용이 끝난 토큰 파일을 홈 디렉터리에서 삭제합니다.

- **`rm`**: 파일을 삭제하는 명령어
- **`~/node-token`**: 삭제할 파일 경로

> 💡 민감한 정보는 사용 후 즉시 정리하는 것이 좋은 습관입니다.
```

**13) Worker Node가 정상적으로 등록되었는지 Master Node에서 확인**

```bash
kubectl get nodes -o wide
```
```tech
kubernetes
```

```desc
#### 📋 클러스터 노드 상태 확인
`kubectl`을 사용하여 클러스터에 포함된 모든 노드의 목록과 상태를 확인합니다.

- **`kubectl get nodes`**: 클러스터의 모든 노드를 나열
- **`-o wide`**: IP 주소, 컨테이너 런타임 등 더 상세한 정보를 함께 표시

> 💡 `STATUS`가 `Ready`로 표시되면 워커 노드가 성공적으로 클러스터에 참여하여 작업을 받을 준비가 되었음을 의미합니다.
```

**14) Master Node 접속 종료**

```bash
exit
```
```tech
ssh
```

**15) 실습 종료**

```bash
: quit
```

```tech
bash,rocky
```

```desc
#### 👋 실습 종료
실습을 종료를 의미하는 `quit` 명령어를 실행합니다.
현재 터미널 세션을 종료합니다.

> 💡 모든 실습을 마친 후 사용합니다.
```