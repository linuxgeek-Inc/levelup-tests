##### K8s: 웹서버 3개 복제본을 갖는 Deployment 배포 방법 #####

**1) Deployment 생성**
```bash
kubectl create deployment nginx-deployment --image=nginx --replicas=3
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🚀 3개의 복제본을 갖는 Deployment 생성
동일한 Nginx Pod 3개를 관리하는 Deployment를 생성합니다.

- **`kubectl create deployment`**: 새로운 Deployment를 만듭니다.
- **`--image=nginx`**: 사용할 컨테이너 이미지입니다.
- **`--replicas=3`**: 동일한 Pod를 3개 생성하여 유지하도록 설정합니다.

> 💡 복제본(Replica)을 여러 개 두면 서비스 안정성과 부하 분산에 유리합니다.
```

**2) Deployment가 준비 될 때까지 wait**
```bash
kubectl wait --for=condition=available deployment/nginx-deployment --timeout=60s
```
```tech
kubectl
```
```desc
#### ⏳ Deployment 준비 대기
Deployment에 속한 모든 Pod들이 준비 상태가 될 때까지 기다립니다.

- **`kubectl wait`**: 특정 조건이 충족될 때까지 대기합니다.
- **`--for=condition=available`**: Deployment가 사용 가능한 상태(모든 복제본이 준비됨)가 될 때까지 기다립니다.
- **`--timeout=60s`**: 최대 60초 동안 기다립니다.

> 💡 이 단계를 통해 이후 명령어들이 정상적으로 실행될 수 있도록 보장합니다.
```

**3) Deployment 상태 모니터링**
```bash
timeout 10 watch kubectl get deployment nginx-deployment
```
```tech
bash,kubectl,kubernetes,watch
```
```desc
#### 👀 Deployment 상태 모니터링
10초 동안 Deployment의 상태 변화를 실시간으로 확인합니다.

- **`watch`**: 명령어를 주기적으로 실행하여 결과를 보여줍니다.
- **`kubectl get deployment`**: Deployment의 상태를 조회합니다.
- **`READY`** 컬럼이 `3/3`이 되면 모든 Pod가 정상적으로 실행된 것입니다.

> 💡 `UP-TO-DATE`와 `AVAILABLE` 컬럼을 통해 현재 배포 상태를 빠르게 파악할 수 있습니다.
```

**4) 생성된 Pod 목록 확인**
```bash
kubectl get pods -l app=nginx-deployment -o wide
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 📋 생성된 Pod 목록 확인
해당 Deployment가 관리하는 모든 Pod의 목록과 상태를 확인합니다.

- **`kubectl get pods`**: Pod 목록을 조회합니다.
- **`-l app=nginx-deployment`**: `app` 레이블을 기준으로 Pod를 필터링합니다.
- **`-o wide`**: Pod IP, 노드 위치 등 상세 정보를 표시합니다.

> 💡 3개의 Pod가 각각 다른 이름으로 생성되고, 여러 노드에 분산되어 실행될 수 있음을 확인할 수 있습니다.
```

**5) NodePort 타입의 Service 생성**
```bash
kubectl expose deployment nginx-deployment --port=80 --type=NodePort
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🔌 NodePort 타입 Service 생성
클러스터 외부에서 Pod에 접근할 수 있도록 Service를 생성하고 노출시킵니다.

- **`kubectl expose deployment`**: Deployment를 외부에 노출시키는 Service를 생성합니다.
- **`--port=80`**: Service가 내부적으로 Pod와 통신할 포트입니다.
- **`--type=NodePort`**: 클러스터의 모든 노드(Node)에 외부에서 접근 가능한 포트를 엽니다.

> 💡 `NodePort` Service는 각 노드의 특정 포트로 들어온 요청을 해당 Service에 연결된 Pod로 전달합니다.
```

**6) Service 정보 확인**
```bash
kubectl get service nginx-deployment
```
```tech
bash,kubectl,kubernetes
```
```desc
#### ℹ️ Service 정보 확인
생성된 Service의 상세 정보를 확인합니다.

- **`kubectl get service`**: Service 목록 및 정보를 조회합니다.
- **`TYPE`**이 `NodePort`로 설정되었는지 확인합니다.
- **`PORT(S)`** 항목에서 `80:NodePort/TCP` 형식으로 표시된 `NodePort` 번호를 확인해야 합니다.

> 💡 `CLUSTER-IP`는 클러스터 내부에서만 사용 가능한 가상 IP입니다.
```

**7) NodePort 확인 및 변수 저장**
```bash
export NODE_PORT=$(kubectl get service nginx-deployment -o jsonpath='{.spec.ports[0].nodePort}')
```
```tech
bash,echo,kubectl,kubernetes
```
```desc
#### 💾 NodePort 번호 변수 저장
외부에서 접속할 때 사용할 `NodePort` 번호를 변수에 저장합니다.

- **`export`**: 환경 변수로 설정하여 현재 셸 세션 동안 계속 사용할 수 있게 합니다.
- **`-o jsonpath='{.spec.ports[0].nodePort}'`**: Service 정보에서 `NodePort` 값만 정확히 추출합니다.

> 💡 `jsonpath`를 사용하면 복잡한 출력 결과에서 원하는 값만 깔끔하게 가져올 수 있습니다.
```

```bash
echo "Nginx Service NodePort: $NODE_PORT"
```
```tech
bash,echo,kubectl,kubernetes
```
```desc
#### 🗣️ NodePort 번호 확인
변수에 저장된 `NodePort` 번호를 출력하여 확인합니다.

- **`echo`**: 변수의 값을 터미널에 출력합니다.

> 💡 보통 30000-32767 사이의 임의의 포트 번호가 할당됩니다.
```

**8) Master Node로 접속 테스트**
```bash
curl http://192.168.0.2:$NODE_PORT
```
```tech
bash,curl
```
```desc
#### ✅ Master Node로 접속 테스트
Master Node의 IP와 `NodePort`를 이용해 웹 서버에 접속을 시도합니다.

- **`curl`**: URL로 HTTP 요청을 보냅니다.
- **`http://192.168.0.2:$NODE_PORT`**: Master Node의 IP와 할당된 `NodePort`로 접속합니다.

> 💡 어느 노드로 접속하든 Service가 요청을 받아 3개의 Nginx Pod 중 하나로 전달해줍니다.
```

**9) Worker Node로 접속 테스트**
```bash
curl http://192.168.0.3:$NODE_PORT
```
```tech
bash,curl
```
```desc
#### ✅ Worker Node로 접속 테스트
Worker Node의 IP와 `NodePort`를 이용해 웹 서버에 접속을 시도합니다.

- **`curl`**: URL로 HTTP 요청을 보냅니다.
- **`http://192.168.0.3:$NODE_PORT`**: Worker Node의 IP와 할당된 `NodePort`로 접속합니다.

> 💡 Master/Worker 노드 어디로 접속해도 동일한 Nginx 환영 페이지가 보이면 성공입니다. 이것이 `NodePort` Service의 특징입니다.
```

**10) Deployment 삭제**
```bash
kubectl delete deployment nginx-deployment
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🧹 Deployment 삭제
실습에 사용된 Deployment를 삭제합니다.

- **`kubectl delete deployment`**: Deployment와 그에 속한 Pod들을 모두 삭제합니다.

> 💡 Deployment를 먼저 삭제하여 Pod들이 정리되도록 합니다.
```

**11) Service 삭제**
```bash
kubectl delete service nginx-deployment
```
```tech
bash,kubectl,kubernetes
```
```desc
#### 🧹 Service 삭제
실습에 사용된 Service를 삭제합니다.

- **`kubectl delete service`**: Service 리소스를 삭제합니다.

> 💡 Deployment와 Service는 별개의 리소스이므로 각각 삭제해주어야 합니다.
```

**12) 실습 종료**

```bash
: quit
```

```tech
bash,rocky
```

```desc
#### 👋 실습 종료
실습을 종료를 의미하는 `quit` 명령어를 실행합니다.
현재 터미널 세션을 종료합니다.

> 💡 모든 실습을 마친 후 사용합니다.
```