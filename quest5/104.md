##### Swarm: μ„λΉ„μ¤ λ΅¤λ§ μ—…λ°μ΄νΈ #####

**μ°Έκ³ :** μ΄ μ‹¤μµμ—μ„λ” κ΄€λ¦¬μ λ…Έλ“ IPλ΅ `192.168.0.2`μ„ μ‚¬μ©ν•©λ‹λ‹¤. μ‹¤μ  ν™κ²½μ— λ§κ² IP μ£Όμ†λ¥Ό λ³€κ²½ν•μ—¬ μ‹¤ν–‰ν•μ„Έμ”.

**1) Manager Node: μ΄μ „ λ²„μ „ Nginx μ„λΉ„μ¤ μƒμ„±**
λ΅¤λ§ μ—…λ°μ΄νΈλ¥Ό μ‹¤μµν•κΈ° μ„ν•΄, λ¨Όμ € νΉμ • λ²„μ „(1.21)μ Nginxλ΅ `nginx-updater` μ„λΉ„μ¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤.

```bash
docker service create --name nginx-updater --replicas 2 --publish published=8082,target=80 nginx:1.21
```

```tech
docker, swarm, nginx
```

```desc
#### π€ μ΄μ „ λ²„μ „ μ„λΉ„μ¤ μƒμ„±
λ΅¤λ§ μ—…λ°μ΄νΈλ¥Ό ν…μ¤νΈν•κΈ° μ„ν•΄ νΉμ • κµ¬λ²„μ „(1.21)μ Nginx μ„λΉ„μ¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤.

- **`docker service create`**: μƒλ΅μ΄ μ„λΉ„μ¤λ¥Ό μƒμ„±
- **`nginx:1.21`**: Nginx μ΄λ―Έμ§€μ νΉμ • λ²„μ „μ„ μ§€μ •

> π’΅ μ—…λ°μ΄νΈ μ „μ μƒνƒλ¥Ό λ§λ“¤κΈ° μ„ν•΄ μλ„μ μΌλ΅ μ΄μ „ λ²„μ „μ„ λ°°ν¬ν•©λ‹λ‹¤.
```

**2) Manager Node: λ°°ν¬λ Nginx λ²„μ „ ν™•μΈ**
μ„λΉ„μ¤μ— μ ‘μ†ν•μ—¬ ν„μ¬ λ°°ν¬λ Nginxμ λ²„μ „μ„ ν™•μΈν•©λ‹λ‹¤. `Server` ν—¤λ”μ—μ„ `nginx/1.21.x`λ¥Ό ν™•μΈν•  μ μμµλ‹λ‹¤.

```bash
curl --head http://192.168.0.2:8082
```

```tech
docker, swarm, nginx
```

```desc
#### π” ν„μ¬ λ²„μ „ ν™•μΈ
`curl --head`λ¥Ό μ‚¬μ©ν•μ—¬ μ„λΉ„μ¤μ HTTP μ‘λ‹µ ν—¤λ”λ¥Ό ν™•μΈν•κ³ , ν„μ¬ μ‹¤ν–‰ μ¤‘μΈ Nginx λ²„μ „μ„ νμ•…ν•©λ‹λ‹¤.

- **`curl --head`**: HTTP λ³Έλ¬Έ μ—†μ΄ ν—¤λ” μ •λ³΄λ§ κ°€μ Έμ΄
- **`Server: nginx/1.21.x`**: μ‘λ‹µ ν—¤λ”μ—μ„ ν„μ¬ λ²„μ „μ„ ν™•μΈν•  μ μμ

> π’΅ μ—…λ°μ΄νΈκ°€ μ λ€λ΅ λμ—λ”μ§€ λΉ„κµν•κΈ° μ„ν•΄ ν„μ¬ μƒνƒλ¥Ό κΈ°λ΅ν•λ” κ³Όμ •μ…λ‹λ‹¤.
```

**3) Manager Node: μ„λΉ„μ¤ λ΅¤λ§ μ—…λ°μ΄νΈ μ‹¤ν–‰**
`docker service update` λ…λ Ήμ–΄λ¥Ό μ‚¬μ©ν•μ—¬ `nginx-updater` μ„λΉ„μ¤μ μ΄λ―Έμ§€λ¥Ό `latest` λ²„μ „μΌλ΅ μ—…λ°μ΄νΈν•©λ‹λ‹¤. Swarmμ€ κΈ°μ΅΄ μ»¨ν…μ΄λ„λ¥Ό ν• λ²μ— ν•λ‚μ”© μƒλ΅μ΄ λ²„μ „μΌλ΅ κµμ²΄ν•©λ‹λ‹¤.

```bash
docker service update --image nginx:latest nginx-updater
```

```tech
docker, swarm, nginx
```

```desc
#### π”„ μ„λΉ„μ¤ λ΅¤λ§ μ—…λ°μ΄νΈ μ‹¤ν–‰
`docker service update`λ¥Ό μ‚¬μ©ν•μ—¬ μ„λΉ„μ¤ μ¤‘λ‹¨ μ—†μ΄ μ΄λ―Έμ§€λ¥Ό μƒ λ²„μ „μΌλ΅ κµμ²΄ν•©λ‹λ‹¤.

- **`docker service update`**: μ‹¤ν–‰ μ¤‘μΈ μ„λΉ„μ¤μ μ„¤μ •μ„ λ³€κ²½
- **`--image nginx:latest`**: μ„λΉ„μ¤μ μ΄λ―Έμ§€λ¥Ό `nginx:latest`λ΅ λ³€κ²½
- **`nginx-updater`**: μ—…λ°μ΄νΈν•  μ„λΉ„μ¤μ μ΄λ¦„

> π’΅ Swarmμ€ κΈ°λ³Έμ μΌλ΅ ν• λ²μ— ν•λ‚μ”© κµ¬λ²„μ „ μ»¨ν…μ΄λ„λ¥Ό λ‚΄λ¦¬κ³  μƒ λ²„μ „ μ»¨ν…μ΄λ„λ¥Ό μ¬λ¦¬λ” 'λ΅¤λ§ μ—…λ°μ΄νΈ'λ¥Ό μν–‰ν•μ—¬ μ„λΉ„μ¤ κ°€μ©μ„±μ„ μ μ§€ν•©λ‹λ‹¤.
```

**4) Manager Node: λ΅¤λ§ μ—…λ°μ΄νΈ κ³Όμ • μ‹¤μ‹κ°„ λ¨λ‹ν„°λ§**
`watch`λ¥Ό μ‚¬μ©ν•μ—¬ μ„λΉ„μ¤μ μ‘μ—…(Task) μƒνƒλ¥Ό μ‹¤μ‹κ°„μΌλ΅ κ΄€μ°°ν•©λ‹λ‹¤. μ΄μ „ λ²„μ „μ μ»¨ν…μ΄λ„κ°€ `Shutdown`λκ³  μƒλ΅μ΄ λ²„μ „μ μ»¨ν…μ΄λ„κ°€ `Running` μƒνƒκ°€ λλ” κ³Όμ •μ„ λ³Ό μ μμµλ‹λ‹¤.

```bash
timeout 10 watch docker service ps nginx-updater
```
```no-err-check
```
```tech
docker, swarm
```

```desc
#### β±οΈ μ—…λ°μ΄νΈ κ³Όμ • λ¨λ‹ν„°λ§
`watch`μ™€ `docker service ps`λ¥Ό μ΄μ©ν•΄ λ΅¤λ§ μ—…λ°μ΄νΈ κ³Όμ •μ„ μ‹¤μ‹κ°„μΌλ΅ μ§€μΌλ΄…λ‹λ‹¤.

- **`watch docker service ps ...`**: μ„λΉ„μ¤μ μ‘μ—… μƒνƒλ¥Ό μ£ΌκΈ°μ μΌλ΅ ν™•μΈ
- **`Shutdown`**: κµ¬λ²„μ „ μ»¨ν…μ΄λ„κ°€ μΆ…λ£λλ” μƒνƒ
- **`Running`**: μƒ λ²„μ „ μ»¨ν…μ΄λ„κ°€ μ‹¤ν–‰λλ” μƒνƒ

> π’΅ μ»¨ν…μ΄λ„λ“¤μ΄ μμ°¨μ μΌλ΅ κµμ²΄λλ” λ¨μµμ„ ν†µν•΄ λ¬΄μ¤‘λ‹¨ μ—…λ°μ΄νΈκ°€ μ–΄λ–»κ² μ΄λ£¨μ–΄μ§€λ”μ§€ ν™•μΈν•  μ μμµλ‹λ‹¤.
```

**5) Manager Node: μ—…λ°μ΄νΈλ Nginx λ²„μ „ ν™•μΈ**
μ—…λ°μ΄νΈκ°€ μ™„λ£λ ν›„, λ‹¤μ‹ μ„λΉ„μ¤μ— μ ‘μ†ν•μ—¬ `Server` ν—¤λ”κ°€ μµμ‹  λ²„μ „μΌλ΅ λ³€κ²½λμ—λ”μ§€ ν™•μΈν•©λ‹λ‹¤.

```bash
curl --head http://192.168.0.2:8082
```

```tech
docker, swarm, nginx
```

```desc
#### β… μµμΆ… λ²„μ „ ν™•μΈ
μ—…λ°μ΄νΈ μ™„λ£ ν›„, λ‹¤μ‹ `curl --head`λ¥Ό μ‹¤ν–‰ν•μ—¬ Nginx λ²„μ „μ΄ μ„±κ³µμ μΌλ΅ λ³€κ²½λμ—λ”μ§€ μµμΆ… ν™•μΈν•©λ‹λ‹¤.

- **`Server: nginx/1.2x.x`**: μ‘λ‹µ ν—¤λ”μ λ²„μ „μ΄ μ΄μ „κ³Ό λ‹¤λ¥Έ μµμ‹  λ²„μ „μΌλ΅ ν‘μ‹λμ–΄μ•Ό ν•¨

> π’΅ μ΄μ „ λ²„μ „κ³Ό λΉ„κµν•μ—¬ μ„λ²„ λ²„μ „μ΄ μ¬λΌκ°”λ‹¤λ©΄ λ΅¤λ§ μ—…λ°μ΄νΈκ°€ μ„±κ³µμ μΌλ΅ μ™„λ£λ κ²ƒμ…λ‹λ‹¤.
```

**6) μ‹¤μµ μΆ…λ£**

```bash
: quit
```

```tech
bash,rocky
```

```desc
#### π‘‹ μ‹¤μµ μΆ…λ£
μ‹¤μµμ„ μΆ…λ£λ¥Ό μλ―Έν•λ” `quit` λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤.
ν„μ¬ ν„°λ―Έλ„ μ„Έμ…μ„ μΆ…λ£ν•©λ‹λ‹¤.

> π’΅ λ¨λ“  μ‹¤μµμ„ λ§μΉ ν›„ μ‚¬μ©ν•©λ‹λ‹¤.
```